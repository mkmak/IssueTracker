<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- <base href="https://b-hw2-38225.firebaseapp.com/"> -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Muli"> -->
  <!-- <link rel="stylesheet" type="text/css" href="styles.css"> -->
  <style>
    header p,nav ul{float:right}header,nav li{background:#000;color:#fff}body,input{line-height:1.5}header,nav a,nav a:visited,nav li{color:#fff}body{font-family:Muli,sans-serif;padding:0;margin:0}button{font-size:80%;border:2px solid #00a7f5;border-radius:3px;padding:4px 8px;background:#c6edff;cursor:pointer}.container{padding:10px 20px;margin:auto;overflow:hidden}#home_issue,#home_login,#home_logout #issue_img,#home_signup{display:none}header{min-height:70px}header #header{float:left;padding:15px}nav ul{padding:20px 15px 15px}nav li{display:inline;padding:5px 15px}nav a:hover{background:red}#issue_img{display:block;margin-left:auto;margin-right:auto;padding-bottom:15px}hr{margin:10px 0}legend{padding:0 10px}button.delete-button:hover{background:#ff6b6b}button:hover,th{background:#7ad5ff}button[type=submit]{margin:5px}.col1,.col2{float:left;margin-top:6px}.row{padding:7px}.col1{width:25%}.col2{width:75%}table{border-collapse:collapse;width:100%;max-width:1000px}.issuename{max-width:45px}.issuetype{max-width:50px}.issuestat{width:25px;text-align:center}.issuestat button{min-width:60px}.issueact{width:95px;text-align:center}td>button{margin:auto}td,th{border:1px solid #bbb;padding:6px}tr:nth-child(odd){background:#ddf4ff}tr:hover{background:#bfebff}img{max-width:100%;height:auto}img.icon{height:15px;width:15px}button-block{border:2px solid #00a7f5;display:inline-block}@media screen and (max-width:600px){.issuedesc,.issueid{display:none}.col1,.col2,textarea{width:100%;margin-top:3px}}@media screen and (max-width:400px){.issuedesc,.issueid,.issuetype{display:none}}
  </style>
  <meta name="theme-color" content="#33a4fd">
  <link rel="stylesheet" media="print" href="print.css" type="text/css">
  <link rel="icon" href="images/favicon.png">
  <title>Issues</title>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(function () {
          console.log('Service Worker Registered');
        });
    }
  </script>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <header>
    <div class="container">
      <h2 id="header">Issues List:</h2>
      <nav>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li>Issues</li>
          <li><a id="signoutbtn" href="index.html">Log Out</a></li>
        </ul>
      </nav>
    </div>
  </header>
  <br>
  <div class="container">
    <noscript>
      <p>Javascript must be enabled for some functionalities to work.</p>
    </noscript>
    <input type="checkbox" id="filter-checkbox"> Show only open issues<br>
    <template>
      <tr>
        <td class="issuename"><a href=""></a></td>
        <td class="issuetype"></td>
        <td class="issuedesc"></td>
        <td class="issuestat"><button class="button-block" onclick="toggle(this)"></button></td>
        <td class="issueact"><button class="button-block delete-button" onclick="remove(this)">Delete <img class="icon" width="15" height="15" src="images/delete_icon.svg" alt="delete"></button>
        </td>
      </tr>
    </template>
    <table id="issues-table">
      <colgroup>
        <col class="issuename">
        <col class="issuetype">
        <col class="issuedesc">
        <col class="issuestat">
        <col class="issueact">
      </colgroup>
      <tr>
        <th class="issuename">Issue Name</th>
        <th class="issuetype">Issue Type</th>
        <th class="issuedesc">Issue Description</th>
        <th class="issuestat">Status</th>
        <th class="issueact">Action</th>
      </tr>
      <tr>
        <td colspan="5">Loading...</th>
      </tr>
      <!-- <tr>
        <td class="issueid">1</td>
        <td class="issuename"><a href="issue1.html">IE6 not supported</a></td>
        <td class="issuetype">Browser-specific</td>
        <td class="issuedesc">User reports that site does not work in IE6.</td>
        <td class="issuestat"><button class="button-block" onclick="toggle(this)">Open</button></td>
        <td class="issueact"><button class="button-block" onclick="location.href='editissue.html'">Edit <img class="icon" width="15" height="15" src="images/edit_icon.png" alt="edit"></button>
                          <button class="button-block" onclick="remove(this)">Delete <img class="icon" width="15" height="15" src="images/delete_icon.svg" alt="delete"></button>
                      </td>
      </tr>
      <tr>
        <td class="issueid">2</td>
        <td class="issuename"><a href="issue2.html">Reset Password Link</a></td>
        <td class="issuetype">HTML Content</td>
        <td class="issuedesc">The reset password button under the login form leads to a 404 page. It appears that the link is broken.</td>
        <td class="issuestat"><button class="button-block" onclick="toggle(this)">Closed</button></td>
        <td class="issueact"><button class="button-block" onclick="location.href='editissue.html'">Edit <img class="icon" width="15" height="15" src="images/edit_icon.png" alt="edit"></button>
                          <button class="button-block" onclick="remove(this)">Delete <img class="icon" width="15" height="15" src="images/delete_icon.svg" alt="delete"></button>
                      </td>
      </tr>
      <tr>
        <td class="issueid">3</td>
        <td class="issuename"><a href="issue3.html">Logo Missing</a></td>
        <td class="issuetype">HTML Content</td>
        <td class="issuedesc">The company logo at the center of the main page is missing.</td>
        <td class="issuestat"><button class="button-block" onclick="toggle(this)">Closed</button></td>
        <td class="issueact"><button class="button-block" onclick="location.href='editissue.html'">Edit <img class="icon" width="15" height="15" src="images/edit_icon.png" alt="edit"></button>
                          <button class="button-block" onclick="remove(this)">Delete <img class="icon" width="15" height="15" src="images/delete_icon.svg" alt="delete"></button>
                      </td>
      </tr>
      <tr>
        <td class="issueid">4</td>
        <td class="issuename"><a href="issue4.html">Search Timeout</a></td>
        <td class="issuetype">Functionality</td>
        <td class="issuedesc">In-site searching is broken.</td>
        <td class="issuestat"><button class="button-block" onclick="toggle(this)">Open</button></td>
        <td class="issueact"><button class="button-block" onclick="location.href='editissue.html'">Edit <img class="icon" width="15" height="15" src="images/edit_icon.png" alt="edit"></button>
                          <button class="button-block" onclick="remove(this)">Delete <img class="icon" width="15" height="15" src="images/delete_icon.svg" alt="delete"></button>
                      </td>
      </tr> -->
    </table>
    <br>
    <button id="addbtn" type="button" onclick="window.location.href='addissue.html'">Add Issue</button><br>
    <button id="loadbutton" type="button">Switch to REST</button><br>
    <noscript>
      <br><a href="addissue.html">Link to Add Issue</a>
    </noscript>
  </div>

  <script>
    (function() {
      var link = document.createElement('link');
      link.rel = "stylesheet";
      link.href = "//fonts.googleapis.com/css?family=Muli";
      document.querySelector("head").appendChild(link);
    })();
  </script>
  
  <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase.js"></script>
  <script src="initFirebase.js"></script>
  <script>
    function toggle(btn) {
      var change_id = btn.parentElement.parentElement.getAttribute('data-id');
      if (btn.innerHTML == "Open") {
        btn.innerHTML = "Closed";
        db.collection('users').doc(firebase.auth().currentUser.uid).collection('issues').doc(change_id).set({
          open: false
        }, {merge: true});
        ref.child(change_id).update({open: false});
      }
      else {
        btn.innerHTML = "Open";
        db.collection('users').doc(firebase.auth().currentUser.uid).collection('issues').doc(change_id).set({
          open: true
        }, {merge: true});
        ref.child(change_id).update({open: true});
      }
    }
    function remove(link) {
      var change_id = link.parentElement.parentElement.getAttribute('data-id');

      firebase.auth().currentUser.getIdToken(true).then(function(idToken) {
          var xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
            if(xhttp.readyState === 4 && xhttp.status === 200) {
              console.log('deleted from rest');
            }
          };
          xhttp.open("DELETE", 'https://b-hw2-38225.firebaseio.com/issues/'+change_id+'.json?auth='+idToken, true);
          xhttp.setRequestHeader("Content-type", "application/json");
          xhttp.send();
        });

      db.collection('users').doc(firebase.auth().currentUser.uid).collection('issues').doc(change_id).delete()
      .then(function() {
        console.log("Document successfully deleted!");
      })
      .catch(function(error) {
        console.error("Error removing document: ", error);
      });
      link.parentElement.parentElement.remove();
    }

    function logout(){
      firebase.auth().signOut();
    }
    document.getElementById('signoutbtn').addEventListener('click', logout);

    // firebase
    firebase.firestore().enablePersistence()
    .then(function() {
      var db = firebase.firestore();
    })
    .catch(function(err) {
      if (err.code == 'failed-precondition') {
        alert('Multiple tabs opened. Please close the other ones.')
      } else if (err.code == 'unimplemented') {
        alert('Your browser does not support offline features.')
      }
    });
    const settings = {timestampsInSnapshots: true};
    db.settings(settings);

    var ref = firebase.database().ref('issues');
    var state = "firestore";

    // template access
    var row_temp = document.getElementsByTagName("template")[0].content.querySelector("tr");
    var table = document.getElementById('issues-table');


    // wait on auth, then load issues
    firebase.auth().onAuthStateChanged(function() {
      db.collection('users').doc(firebase.auth().currentUser.uid).collection('issues').get()
      .then(function(querySnapshot){
        document.getElementsByTagName('tr')[1].remove();
        querySnapshot.forEach(function(doc) {
          // console.log(doc.id, " => ", doc.data());
          new_row = document.importNode(row_temp, true);
          
          new_row.setAttribute('data-id', doc.id);
          new_row.getElementsByClassName('issuename')[0].getElementsByTagName('a')[0].innerHTML = doc.data().title;
          new_row.getElementsByClassName('issuename')[0].getElementsByTagName('a')[0].setAttribute('href', 'detail.html?id='+doc.id);
          new_row.getElementsByClassName('issuetype')[0].innerHTML = doc.data().type;
          new_row.getElementsByClassName('issuedesc')[0].innerHTML = doc.data().description;
          if (doc.data().open === true) {
            new_row.getElementsByClassName('issuestat')[0].getElementsByTagName('button')[0].innerHTML = 'Open';
          } else {
            new_row.getElementsByClassName('issuestat')[0].getElementsByTagName('button')[0].innerHTML = 'Closed';
          }
          table.appendChild(new_row);
        });
      });
    });
    
    // Open issue filter checkbox
    document.getElementById("filter-checkbox").addEventListener('change', function() {
      var table = document.getElementById('issues-table');
      if (this.checked) {
        for (var i = 1, row; row = table.rows[i]; i++) {
          if (row.getElementsByTagName('button')[0].innerHTML === 'Closed') {
            row.style.visibility = "collapse";
          }
        }
      } else {
        for (var i = 1, row; row = table.rows[i]; i++) {
          if (row.getElementsByTagName('button')[0].innerHTML === 'Closed') {
            row.style.visibility = "visible";
          }
        }
      }
    });

    // Get issues from Realtime Database
    document.getElementById('loadbutton').addEventListener('click', function() {

      if(state === 'firestore'){
        state = 'realtime';
        document.getElementById('loadbutton').innerHTML = 'Switch to Cloud Firestore';
        var table = document.getElementById('issues-table');
        for (var i = 1, row; row = table.getElementsByTagName('tr')[i]; i) {
          row.remove();
        }
        firebase.auth().currentUser.getIdToken(true).then(function(idToken) {
          var xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
            if(xhttp.readyState === 4 && xhttp.status === 200) {
              populate(JSON.parse(xhttp.responseText));
            }
          };
          xhttp.open("GET", "https://b-hw2-38225.firebaseio.com/issues.json?auth=" + idToken, true);
          xhttp.setRequestHeader("Content-type", "application/json");
          xhttp.send();
        });
      }else{
        location.href = 'issues.html';
      }
    });

    function populate(data) {
      console.log(data);
      
      ref.once('value', function(snapshot){
        snapshot.forEach(function(childSnapshot){
          ref.child(childSnapshot.key).once('value').then(function(s){

            new_row = document.importNode(row_temp, true);
            new_row.setAttribute('data-id', childSnapshot.key);
            new_row.getElementsByClassName('issuename')[0].getElementsByTagName('a')[0].innerHTML = s.val().title;
            new_row.getElementsByClassName('issuename')[0].getElementsByTagName('a')[0].setAttribute('href', 'detail.html?id='+childSnapshot.key);
            new_row.getElementsByClassName('issuetype')[0].innerHTML = s.val().type;
            new_row.getElementsByClassName('issuedesc')[0].innerHTML = s.val().description;
            if (s.val().open === true) {
              new_row.getElementsByClassName('issuestat')[0].getElementsByTagName('button')[0].innerHTML = 'Open';
            } else {
              new_row.getElementsByClassName('issuestat')[0].getElementsByTagName('button')[0].innerHTML = 'Closed';
            }
            table.appendChild(new_row);
          });
        });

      });
    
    }
  </script>

</body>
</html>
