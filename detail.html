<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Muli">
  <link rel="stylesheet" type="text/css" href="styles.css">
  <link rel="stylesheet" media="print" href="print.css" type="text/css">
  <link rel="icon" href="images/favicon.png">
  <title>Issue Detail</title>

  <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase.js"></script>
  <script src="initFirebase.js"></script>
</head>

<body>
  <header>
    <div class="container">
      <h2 id="header"></h2>
      <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="issues.html">Issues</a></li>
            <li><a id="signoutbtn" href="index.html">Log Out</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <hr>

  <section>
    <div class="container">
      <img class="issue_img" alt="issue screenshot">
      <p id="issue_p"></p>
    </div>
  </section>

  <script>
    document.getElementById('signoutbtn').addEventListener('click', logout);

    function logout(){
      firebase.auth().signOut();
    }

    var url = window.location.href;
    var pos = url.lastIndexOf('id=');
    var issue_id = url.slice(pos+3, url.length);

    var db = firebase.firestore()
    const settings = {timestampsInSnapshots: true};
    db.settings(settings);

    window.onload = function(){
      init();
    };

    function init(){
      console.log('initializing...');
      firebase.auth().onAuthStateChanged(function(user) {
        if(user){
          db.collection('users').doc(user.uid).collection('issues').doc(issue_id).get().then(function(doc){
            document.getElementById('header').innerHTML = doc.data().title;
            document.getElementById('issue_p').innerHTML = doc.data().description;

            var storageRef = firebase.storage().ref().child(user.uid).child(issue_id);

            storageRef.child(issue_id +'.png').getDownloadURL().then(function(url){
              document.getElementById('issue_img').src = url;
            });
          });
        }
        else{
          
        }
      });
    }
    
    
  </script>

</body>

</html>